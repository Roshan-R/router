---
title: Deploy on Kubernetes
description: Self-hosted deployment of Apollo Router on Kubernetes
---

import { Link } from 'gatsby';
import ElasticNotice from '../../shared/elastic-notice.mdx';
import HelmShowOutput from '../../shared/helm-show-router-output.mdx';
import K8SManualConfig from '../../shared/k8s-manual-config.mdx';
import RouterCommonConfig from '../../shared/router-common-config.mdx';

Learn how to deploy the Apollo Router nd the Apollo Router for a self-hosted supergraph with GraphOS: 

* Get a router Helm chart from the Apollo container repository.
* Deploy a router with a basic Helm chart.
* Configure chart values to export metrics, enable Rhai scripting, and set up a coprocessor.
* Choose chart values that best migrate from gateway to the router.

<ElasticNotice />

## About the router Helm chart

[Helm](https://helm.sh) is a package manager for Kubernetes (k8s). Apollo provides an application Helm chart with each release of Apollo Router in GitHub. Since the router version 0.14.0, Apollo has released the router Helm chart as an [Open Container Initiative (OCI)](https://helm.sh/docs/topics/registries/) image in our GitHub container registry.

> The path to the OCI router chart is `oci://ghcr.io/apollographql/helm-charts/router`.

You customize a router deployment by both setting command-line options and editing YAML configuration files.

## Basic deployment

Follow this guide to deploy the Apollo Router by using Helm to install the basic chart provided with each router release. 

Each router chart has a `values.yaml` file with router and deployment settings. The released, unedited file has a few explicit settings, including:

* Default container ports for the router's (supergraph) [HTTP server](../../configuration/overview/#listen-address), [health check endpoint](../../configuration/health-checks), and [metrics endpoint](../../configuration/metrics).
* Command-line argument to enable [hot reloading of the router](../../configuration/overview/#--hr----hot-reload).
* A single replica.

<ExpansionPanel title="Click to expand values.yaml for router v1.31.0">

The values of the Helm chart for Apollo Router v1.31.0 in the GitHub container repository, as output by the `helm show` command:

```bash
helm show values oci://ghcr.io/apollographql/helm-charts/router
```

<HelmShowOutput/>

</ExpansionPanel>

### Set up Helm

* Install [Helm](https://helm.sh/docs/intro/install/) **version 3.x**. The Apollo Router's Helm chart requires Helm v3.x.

> ⚠️ Your Kubernetes version must be compatible with Helm v3. For details, see [Helm Version Support Policy](https://helm.sh/docs/topics/version_skew/#supported-version-skew).

* Log in with Helm to the Apollo container registry in GitHub.
  
  * Get a GitHub OCI token and save it in an environment variable, `GITHUB_OCI_TOKEN`. For reference, follow the guide for [authenticating to the GitHub container registry](https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry#authenticating-to-the-container-registry).

  * Log in with the `helm registry login` command, using your saved `GITHUB_OCI_TOKEN` and GitHub username:

    ```bash
    echo ${GITHUB_OCI_TOKEN} | helm registry login -u <username> --password-stdin ghcr.io
    ```

* After logging in, verify your access to the registry by showing the latest router chart values with the `helm show values` command:

  ```bash
  helm show values oci://ghcr.io/apollographql/helm-charts/router
  ```

### Set up cluster

Install the tools and provision the infrastructure for your Kubernetes cluster.

> For example, see the [Setup from Apollo's Build a Supergraph tutorial](https://github.com/apollosolutions/build-a-supergraph/tree/main/01-setup#01---setup). It provides steps you can reference for gathering accounts and credentials for your cloud platform (GCP or AWS), provisioning resources, and deploying your subgraphs.

### Set up router

Set up the router by following the [first six steps of the self-hosted router quickstart](/graphos/quickstart/self-hosted) (stopping when you reach step [7. Deploy your router and connect clients](https://www.apollographql.com/docs/graphos/quickstart/self-hosted/#7-deploy-your-router-and-connect-clients)).

### Deploy router

To deploy the router, run the `helm install` command with an argument for the OCI image in the container repository, an argument for the `values.yaml` configuration file, and additional arguments to override specific configuration values.

```bash
helm install --set managedFederation.apiKey="<graph-api-key>" --set managedFederation.graphRef="<graph-ref>"  oci://ghcr.io/apollographql/helm-charts/router --version <router-version> --values router/values.yaml --namespace <router-namespace>
```
The necessary arguments for specific configuration values:

* **Graph ref**. The reference to your managed graph (`id@variant`), the same value as the [`APOLLO_GRAPH_REF` environment variable](../../configuration/overview/#apollo_graph_ref). Used by `helm install` to set `managedFederation.graphRef`.
* **Graph API key**. The API key to your managed graph, the same value as the [`APOLLO_KEY` environment variable](../../configuration/overview/#apollo_key). Used by `helm install` to set `managedFederation.apiKey`.

Some optional arguments:

* **Router version**. The version of the router to deploy. If not specified by `helm install`, the latest version is installed.
* **Namespace**. The namespace scope for this deployment.

### Verify deployment

Verify that your router is one of the deployed releases with the `helm list` command. 

If you deployed with the `--namespace <router-namespace>` option, you can list only the releases within your namespace:

```bash
helm list --namespace <router-namespace>
```

## Deploy with metrics endpoints 

The router supports [metrics endpoints for Prometheus and OTLP](../../configuration/metrics)(OpenTelemetry protocol). A [basic deployment](#basic-deployment) doesn't enable metrics endpoints, because the router chart disables both Prometheus (explicitly) and OTLP (by omission).

To enable metrics endpoints in your deployed router through a YAML configuration file:

* Create a YAML file, `my_values.yaml`, to contain additional values that override default values.
* Edit the file with values to enable metrics endpoints:

  ```yaml title="my_values.yaml"
  router:
    configuration:
      telemetry:
        metrics:
          prometheus:
            enabled: true
            listen: 0.0.0.0:9090
            path: "/metrics"
          otlp:
            temporality: delta
            endpoint: <otlp-endpoint-addr>
  ```

  * `router.telemetry.metrics.prometheus` was already configured but disabled (`enabled: false`) by default. This configuration sets `enabled: true`.
  * `router.telemetry.metrics.otlp` is enabled by inclusion.

* Deploy the router with the additional YAML configuration file. For example, starting with the `helm install` command from the basic deployment step, append `--values my_values.yaml`:

  ```bash
  helm install --set managedFederation.apiKey="<graph-api-key>" --set managedFederation.graphRef="<graph-ref>"  oci://ghcr.io/apollographql/helm-charts/router --version <router-version> --values router/values.yaml --namespace <router-namespace> --values my_values.yaml
  ```

## Deploy with Rhai scripts

The router supports [Rhai scripting](../../customizations/rhai) to add custom functionality.

To enable Rhai scripts in your deployed router through a YAML configuration file:

* Create a YAML file, `my_values.yaml`, to contain additional values that override default values.
* Edit the file with values to enable Rhai scripts:

  ```yaml title="my_values.yaml"
  router:
    configuration:
      rhai:
        scripts: <rhai-scripts-path>
        main: <rhai-main-script>
  ```

* Deploy the router with the additional YAML configuration file. For example, starting with the `helm install` command from the basic deployment step, append `--values my_values.yaml`:

  ```bash
  helm install --set managedFederation.apiKey="<graph-api-key>" --set managedFederation.graphRef="<graph-ref>"  oci://ghcr.io/apollographql/helm-charts/router --version <router-version> --values router/values.yaml --namespace <router-namespace> --values my_values.yaml
  ```

## Deploy with a coprocessor

The router supports [external coprocessing](../../customizations/coprocessor) to run custom logic on requests throughout the [router's request-handling lifecycle](../../customizations/rhai/#router-request-lifecycle).

A deployed coprocessor has its own application image and container in the router pod. 

To configure a coprocessor and its container for your deployed router through a YAML configuration file:

* Create a YAML file, `my_values.yaml`, to contain additional values that override default values.
* Edit the file to configure a coprocessor for the router. For reference, follow the [typical](../../customizations/coprocessor#typical-configuration) and [minimal](../../customizations/coprocessor#minimal-configuration)  configuration examples, and apply them to `router.configuration.coprocessor`. 

```yaml title="my_values.yaml"
router:
  configuration:
    # minimal coprocessor configuration
    coprocessor:
    url: http://127.0.0.1:8081 # Replace with the URL of your coprocessor's HTTP endpoint.
    router:
      request:
        headers: false
```
* Edit the file to add a container for the coprocessor.

```yaml title="my_values.yaml"
extraContainers:
  - name: <coprocessor-deployed-name> # name of deployed container
    image: <coprocessor-app-image> # name of application image
    ports:
      - containerPort: <coprocessor-container-port> # must match port of router.configuration.coprocessor.url
    env: [] # array of environment variables
```

* Deploy the router with the additional YAML configuration file. For example, starting with the `helm install` command from the basic deployment step, append `--values my_values.yaml`:

  ```bash
  helm install --set managedFederation.apiKey="<graph-api-key>" --set managedFederation.graphRef="<graph-ref>"  oci://ghcr.io/apollographql/helm-charts/router --version <router-version> --values router/values.yaml --namespace <router-namespace> --values my_values.yaml
  ```

## Separate configurations per environment

To support your different deployment configurations for different environments (development, staging, production, etc.), Apollo recommends separating your configuration values into separate files:

- A **common** file, which contains values that apply across all environments.
- A unique **environment** file per environment, which includes and overrides the values from the common chart while adding new environment-specific values.

An environment file should include the common file. 

For example, deploy with a `common_values.yaml` file applied first and then a `prod_values.yaml` file:

```bash
helm install --set managedFederation.apiKey="<graph-api-key>" --set managedFederation.graphRef="<graph-ref>"  oci://ghcr.io/apollographql/helm-charts/router --version <router-version> --values router/values.yaml --namespace <router-namespace> --values common_values.yaml --values prod_values.yaml
```

## Configure for migration from gateway

* The gateway's maximum supported request size is 20MB, which is different than the router's default maximum request size, so it needs to be configured.

  ```yaml title="values.yaml"
  router:
    configuration:
      limits:
        experimental_http_max_request_bytes: 20000000 #20MB
  ```

* The router's timeout is increased to accommodate slow subgraphs. Only HTTP 1.1 suport is enabled.

```yaml title="values.yaml"
router:
  configuration:
    traffic_shaping:
      router:
        timeout: 6min
      all:
        experimental_enable_http2: false
        timeout: 5min
```

* The gateway propagates subgraph errors to clients, but the router doesn't by default, so it needs to be configured to propagate subgraph errors.

```yaml title="values.yaml"
router:
  configuration:
    include_subgraph_errors:
      all: true
```
